name: Security Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions: read-all

jobs:
  detect_codeql_languages:
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.detect.outputs.languages }}
      build_mode: ${{ steps.detect.outputs.build_mode }}
    steps:
      - uses: actions/github-script@v7
        id: detect
        with:
          script: |
            const { owner, repo } = context.repo
            const { data: langs } = await github.rest.repos.listLanguages({ owner, repo })

            const languageMap = {
              "C": "cpp",
              "C++": "cpp",
              "Objective-C": "cpp",
              "Objective-C++": "cpp",
              "CUDA": "cpp",
              "C#": "csharp",
              "Go": "go",
              "Java": "java",
              "Kotlin": "kotlin",
              "JavaScript": "javascript",
              "TypeScript": "javascript",
              "Python": "python",
              "Ruby": "ruby",
              "Swift": "swift"
            }

            const supported = new Set()
            for (const name of Object.keys(langs)) {
              const mapped = languageMap[name]
              if (mapped) supported.add(mapped)
            }

            const list = Array.from(supported)
            const needsBuild = ["cpp", "csharp", "java", "go", "swift", "kotlin"]
            const buildMode = list.some((lang) => needsBuild.includes(lang)) ? "autobuild" : "none"

            console.log(`Detected languages: ${Object.keys(langs).join(", ") || "none"}`)
            console.log(`CodeQL languages: ${list.join(", ") || "none"}`)

            core.setOutput("languages", list.join(","))
            core.setOutput("build_mode", buildMode)

  codeql:
    needs: detect_codeql_languages
    if: needs.detect_codeql_languages.outputs.languages != ''
    permissions:
      actions: read
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: ${{ needs.detect_codeql_languages.outputs.languages }}
          build-mode: ${{ needs.detect_codeql_languages.outputs.build_mode }}
      - uses: github/codeql-action/autobuild@v3
        if: needs.detect_codeql_languages.outputs.build_mode == 'autobuild'
      - uses: github/codeql-action/analyze@v3

  gitleaks:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          exit-code: '1'

  clamav:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ClamAV
        run: |
          sudo apt-get update
          sudo apt-get install -y clamav
      - name: Update ClamAV signatures
        run: |
          mkdir -p /tmp/clamav
          cat <<'EOF' > /tmp/freshclam.conf
          DatabaseDirectory /tmp/clamav
          UpdateLogFile /tmp/freshclam.log
          Foreground true
          EOF
          sudo freshclam --config-file=/tmp/freshclam.conf
      - name: Scan with ClamAV
        run: clamscan -r --infected --no-summary --exclude-dir=.git --database=/tmp/clamav .
